{% extends "agenda/base.html" %}
{% load static %}

{% block title %}Kair√≥s.app | Registrar venda{% endblock %}

{% block content %}

<!-- TOPBAR -->
<div class="topbar mb-4 d-flex justify-content-between align-items-center">
  <div>
    <h4 class="mb-1 fw-bold">Registrar venda de produto</h4>
    <div class="hint">R√°pido, direto e sem dor no cora√ß√£o üòÑ</div>
  </div>

  <div class="d-flex gap-2 align-items-center">
    <a href="javascript:history.back()" class="btn btn-outline-secondary ap-btn-soft">‚Üê Voltar</a>
  </div>
</div>

<section class="mb-4">
  <div class="card ap-card ap-animate-in">
    <div class="card-body">

      <form method="post" class="ap-form" id="vendaProdutoForm" autocomplete="off">
        {% csrf_token %}

        {% if form.errors %}
          <div class="alert alert-danger mb-3">
            <div class="fw-bold mb-1">Ops, faltou alguma coisa:</div>
            <ul class="mb-0">
              {% for field, errs in form.errors.items %}
                {% for e in errs %}
                  <li>{{ e }}</li>
                {% endfor %}
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        <div class="row g-3">

          <!-- PRODUTO -->
          <div class="col-12">
            <label class="form-label fw-semibold">Produto</label>

            {# IMPORTANTE: o name precisa ser "produto" (igual no ProductSaleForm) #}
            <select name="produto" id="produtoSelect" class="form-select ap-input">
              {# valor vazio = modo manual (compat√≠vel com ModelChoiceField) #}
              <option value="" {% if not request.POST.produto %}selected{% endif %}>Outro / n√£o cadastrado</option>

              {% for p in produtos %}
                {# tenta pegar pre√ßo em p.preco_venda, sen√£o p.preco, sen√£o 0 #}
                {% with preco=p.preco_venda|default:p.preco %}
                <option
                  value="{{ p.id }}"
                  data-preco="{{ preco|default:'0' }}"
                  {% if request.POST.produto == p.id|stringformat:"s" %}selected{% endif %}
                >
                  {{ p.nome }}
                </option>
                {% endwith %}
              {% endfor %}
            </select>

            <small class="text-muted">Se o produto n√£o existir, deixe em ‚ÄúOutro / n√£o cadastrado‚Äù.</small>
          </div>

          <!-- PRODUTO MANUAL (S√ì APARECE SE ESTIVER EM "OUTRO / N√ÉO CADASTRADO") -->
          <div class="col-12 d-none" id="produtoManualWrap">
            <label class="form-label fw-semibold">Nome do produto (manual)</label>
            <input
              type="text"
              name="produto_nome"
              id="produtoManual"
              class="form-control ap-input"
              placeholder="Ex: Pomada modeladora, Gel, Shampoo..."
              value="{{ request.POST.produto_nome|default:'' }}"
            >
            <small class="text-muted">Esse nome vai entrar na venda mesmo sem estar cadastrado.</small>
          </div>

          <!-- QUANTIDADE -->
          <div class="col-6 col-md-4">
            <label class="form-label fw-semibold">Quantidade</label>
            <input
              type="number"
              name="quantidade"
              id="qtdInput"
              class="form-control ap-input"
              min="1"
              step="1"
              value="{{ request.POST.quantidade|default:'1' }}"
            >
          </div>

          <!-- VALOR UNIT√ÅRIO -->
          <div class="col-6 col-md-4">
            <label class="form-label fw-semibold">Valor unit√°rio (R$)</label>
            <input
              type="text"
              inputmode="decimal"
              name="valor_unitario"
              id="valorInput"
              class="form-control ap-input"
              placeholder="0,00"
              value="{{ request.POST.valor_unitario|default:'' }}"
            >
            <small class="text-muted">Se escolher um produto, o pre√ßo vem junto (mas voc√™ pode editar).</small>
          </div>

          <!-- TOTAL -->
          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold">Total</label>
            <div class="ap-total-box ap-input d-flex align-items-center justify-content-between px-3" style="height: 42px;">
              <span class="text-muted">Total:</span>
              <span class="fw-bold" id="totalSpan">R$ 0,00</span>
            </div>
          </div>

          <!-- OBS -->
          <div class="col-12">
            <label class="form-label fw-semibold">Observa√ß√£o (opcional)</label>
            <input
              type="text"
              name="observacao"
              class="form-control ap-input"
              placeholder="Ex: venda fiado, desconto, brinde..."
              value="{{ request.POST.observacao|default:'' }}"
            >
          </div>

        </div>

        <button class="btn ka-btn-primary btn-lg w-100 ap-btn-glow mt-3" type="submit">
          Registrar venda ‚Üí
        </button>

        <div class="mt-3 ap-note">
          <small class="text-muted">üí° Dica: selecione o produto e o pre√ßo vem junto. O total calcula sozinho.</small>
        </div>

      </form>

    </div>
  </div>
</section>

<!-- JS -->
<script>
(function(){
  const select = document.getElementById("produtoSelect");
  const manualWrap = document.getElementById("produtoManualWrap");
  const manualInput = document.getElementById("produtoManual");
  const qtdInput = document.getElementById("qtdInput");
  const valorInput = document.getElementById("valorInput");
  const totalSpan = document.getElementById("totalSpan");

  function toNumberBR(v){
    if(!v) return 0;
    v = (""+v).trim();
    // remove R$, espa√ßos e coisas estranhas
    v = v.replace(/[^\d,.-]/g, "");
    // se tiver v√≠rgula, assume BR
    v = v.replace(/\./g, "").replace(",", ".");
    const n = parseFloat(v);
    return isNaN(n) ? 0 : n;
  }

  function formatBR(n){
    try {
      return n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    } catch(e){
      return "R$ " + (Math.round(n*100)/100).toFixed(2).replace(".", ",");
    }
  }

  function updateManualVisibility(){
    // manual = quando produto est√° vazio
    const isManual = (select.value === "");
    manualWrap.classList.toggle("d-none", !isManual);

    if(isManual){
      setTimeout(() => manualInput.focus(), 50);
    }
  }

  function maybeFillPrice(){
    const opt = select.options[select.selectedIndex];
    if(!opt) return;

    // se for manual, n√£o mexe no valor
    if(select.value === "") return;

    // s√≥ preenche se o campo estiver vazio (pra n√£o atropelar edi√ß√£o manual)
    if((valorInput.value || "").trim() !== "") return;

    const preco = opt.getAttribute("data-preco") || "0";
    const n = parseFloat(preco);
    const fixed = (isNaN(n) ? 0 : n).toFixed(2).replace(".", ",");
    valorInput.value = fixed;
  }

  function updateTotal(){
    const qtd = parseInt(qtdInput.value || "1", 10) || 1;
    const vUnit = toNumberBR(valorInput.value);
    const total = qtd * vUnit;
    totalSpan.textContent = formatBR(total);
  }

  if(select){
    select.addEventListener("change", () => {
      updateManualVisibility();
      maybeFillPrice();
      updateTotal();
    });
  }

  if(qtdInput) qtdInput.addEventListener("input", updateTotal);
  if(valorInput) valorInput.addEventListener("input", updateTotal);

  // init
  updateManualVisibility();
  maybeFillPrice();
  updateTotal();

})();
</script>

{% endblock %}