{% extends "agenda/base.html" %}
{% load static %}

{% block title %}Kair√≥s.app | Relat√≥rios{% endblock %}

{% block content %}

<!-- TOPBAR -->
<div class="topbar mb-4 d-flex justify-content-between align-items-center">
  <div>
    <h4 class="mb-1 fw-bold">Relat√≥rios</h4>
    <div class="hint">
      Vis√£o geral do desempenho ‚Ä¢ filtros por per√≠odo ‚Ä¢ servi√ßos e produtos
    </div>
  </div>

  <div class="d-flex gap-2 align-items-center">
    <span class="badge-soft">üìä Intelig√™ncia</span>
  </div>
</div>

<!-- FILTROS -->
<section class="mb-4">
  <div class="card ap-card ap-animate-in">
    <div class="card-body">

      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h6 class="mb-0 fw-bold">Filtros</h6>
          <small class="text-muted">Escolha um per√≠odo para calcular os dados</small>
        </div>
        <span class="badge-soft">Kair√≥s.app</span>
      </div>

      <form method="get" class="ap-form" id="relatoriosForm">
        <div class="row g-3">

          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold">Per√≠odo</label>
            <select name="periodo" class="form-select ap-input">
              <option value="hoje"   {% if periodo == "hoje" %}selected{% endif %}>Hoje</option>
              <option value="7d"     {% if periodo == "7d" %}selected{% endif %}>√öltimos 7 dias</option>
              <option value="30d"    {% if periodo == "30d" %}selected{% endif %}>√öltimos 30 dias</option>
              <option value="mes"    {% if periodo == "mes" %}selected{% endif %}>Este m√™s</option>
              <option value="custom" {% if periodo == "custom" %}selected{% endif %}>Personalizado</option>
            </select>
          </div>

          <div class="col-6 col-md-4">
            <label class="form-label fw-semibold">In√≠cio</label>
            <input
              type="date"
              name="inicio"
              class="form-control ap-input"
              value="{{ data_inicio|date:'Y-m-d' }}"
            >
          </div>

          <div class="col-6 col-md-4">
            <label class="form-label fw-semibold">Fim</label>
            <input
              type="date"
              name="fim"
              class="form-control ap-input"
              value="{{ data_fim|date:'Y-m-d' }}"
            >
          </div>

        </div>

        <button class="btn ka-btn-primary btn-lg w-100 ap-btn-glow mt-3" type="submit">
          Atualizar relat√≥rio ‚Üí
        </button>
      </form>

      <div class="mt-3 ap-note">
        <small class="text-muted">üí° Dica: ‚ÄúPersonalizado‚Äù usa as datas in√≠cio/fim.</small>
      </div>

    </div>
  </div>
</section>

<!-- KPI CARDS -->
<section class="mb-4">
  <div class="row g-3">

    <div class="col-12 col-md-3">
      <div class="card ap-card ap-animate-in">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <div class="text-muted small">Agendamentos</div>
              <div class="fs-3 fw-bold">{{ kpi_agendamentos|default:"0" }}</div>
            </div>
            <span class="badge-soft">üìÖ</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-3">
      <div class="card ap-card ap-animate-in">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <div class="text-muted small">Confirmados</div>
              <div class="fs-3 fw-bold">{{ kpi_confirmados|default:"0" }}</div>
            </div>
            <span class="badge-soft">‚úÖ</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-3">
      <div class="card ap-card ap-animate-in">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <div class="text-muted small">Cancelados</div>
              <div class="fs-3 fw-bold">{{ kpi_cancelados|default:"0" }}</div>
            </div>
            <span class="badge-soft">‚úñÔ∏è</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-3">
      <div class="card ap-card ap-animate-in">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <div class="text-muted small">Receita estimada</div>
              <div class="fs-3 fw-bold">{{ kpi_receita|default:"R$ 0,00" }}</div>
            </div>
            <span class="badge-soft">üí∞</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-3">
      <div class="card ap-card ap-animate-in">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <div class="text-muted small">Vendas de produtos</div>
              <div class="fs-3 fw-bold">{{ kpi_produtos_qtd|default:"0" }}</div>
            </div>
            <span class="badge-soft">üß¥</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-3">
      <div class="card ap-card ap-animate-in">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <div class="text-muted small">Itens vendidos</div>
              <div class="fs-3 fw-bold">{{ kpi_produtos_itens|default:"0" }}</div>
            </div>
            <span class="badge-soft">üßæ</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-3">
      <div class="card ap-card ap-animate-in">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <div class="text-muted small">Produtos distintos</div>
              <div class="fs-3 fw-bold">{{ kpi_produtos_distintos|default:"0" }}</div>
            </div>
            <span class="badge-soft">üè∑Ô∏è</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-3">
      <div class="card ap-card ap-animate-in">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <div class="text-muted small">Receita (produtos)</div>
              <div class="fs-3 fw-bold">{{ kpi_produtos_receita|default:"R$ 0,00" }}</div>
            </div>
            <span class="badge-soft">üßæ</span>
          </div>
        </div>
      </div>
    </div>

  </div>
</section>

<!-- TABELAS -->
<section class="mb-4">
  <div class="row g-3">

    <div class="col-12 col-lg-6">
      <div class="card ap-card ap-animate-in">
        <div class="card-body">
          <div class="d-flex justify-content-between mb-2">
            <h6 class="fw-bold mb-0">Servi√ßos mais vendidos</h6>
            <span class="badge-soft">üî•</span>
          </div>

          {% if top_servicos %}
            <div class="table-responsive">
              <table class="table align-middle mb-0">
                <thead>
                  <tr>
                    <th>Servi√ßo</th>
                    <th class="text-end">Qtd</th>
                    <th class="text-end">Receita</th>
                  </tr>
                </thead>
                <tbody>
                  {% for s in top_servicos %}
                  <tr>
                    <td class="fw-semibold">{{ s.nome }}</td>
                    <td class="text-end">{{ s.qtd }}</td>
                    <td class="text-end">{{ s.receita }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="text-muted mb-0">Sem dados no per√≠odo selecionado.</p>
          {% endif %}
        </div>
      </div>

      <div class="card ap-card ap-animate-in mt-3">
        <div class="card-body">
          <div class="d-flex justify-content-between mb-2">
            <h6 class="fw-bold mb-0">Produtos mais vendidos</h6>
            <span class="badge-soft">üß¥</span>
          </div>

          {% if top_produtos %}
            <div class="table-responsive">
              <table class="table align-middle mb-0">
                <thead>
                  <tr>
                    <th>Produto</th>
                    <th class="text-end">Qtd</th>
                    <th class="text-end">Receita</th>
                  </tr>
                </thead>
                <tbody>
                  {% for p in top_produtos %}
                  <tr>
                    <td class="fw-semibold">{{ p.nome }}</td>
                    <td class="text-end">{{ p.qtd }}</td>
                    <td class="text-end">{{ p.receita }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="text-muted mb-0">Sem vendas de produto no per√≠odo selecionado.</p>
          {% endif %}
        </div>
      </div>

      <div class="card ap-card ap-animate-in mt-3">
        <div class="card-body">
          <div class="d-flex justify-content-between mb-2">
            <h6 class="fw-bold mb-0">Detalhamento de produtos</h6>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#produtosDetalhados" aria-expanded="false">
              Ver tudo
            </button>
          </div>

          <div class="collapse" id="produtosDetalhados">
            {% if produtos_detalhados %}
              <div class="table-responsive">
                <table class="table align-middle mb-0">
                  <thead>
                    <tr>
                      <th>Produto</th>
                      <th class="text-end">Qtd</th>
                      <th class="text-end">Receita</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for p in produtos_detalhados %}
                    <tr>
                      <td class="fw-semibold">{{ p.nome }}</td>
                      <td class="text-end">{{ p.qtd }}</td>
                      <td class="text-end">{{ p.receita }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="text-muted mb-0">Sem vendas de produto no per√≠odo selecionado.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card ap-card ap-animate-in">
        <div class="card-body">
          <div class="d-flex justify-content-between mb-2">
            <h6 class="fw-bold mb-0">Resumo por dia</h6>
            <span class="badge-soft">üìà</span>
          </div>

          {% if resumo_por_dia %}
            <div class="table-responsive">
              <table class="table align-middle mb-0">
                <thead>
                  <tr>
                    <th>Dia</th>
                    <th class="text-end">Agend.</th>
                    <th class="text-end">Confirm.</th>
                    <th class="text-end">Cancel.</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in resumo_por_dia %}
                  <tr>
                    <td class="fw-semibold">{{ r.dia }}</td>
                    <td class="text-end">{{ r.agendamentos }}</td>
                    <td class="text-end">{{ r.confirmados }}</td>
                    <td class="text-end">{{ r.cancelados }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="text-muted mb-0">Sem dados no per√≠odo selecionado.</p>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
</section>

<!-- SKELETON -->
<section id="skeletonRelatorios" class="mb-4 d-none">
  <div class="card ap-card ap-skeleton">
    <div class="card-body">
      <div class="ap-skel-line w-25 mb-3"></div>
      <div class="ap-skel-line w-100 mb-2"></div>
      <div class="ap-skel-line w-100 mb-2"></div>
      <div class="ap-skel-line w-75 mb-4"></div>
      <div class="ap-skel-btn"></div>
    </div>
  </div>
</section>

<script>
  // Skeleton loading
  (function(){
    const form = document.getElementById("relatoriosForm");
    const skel = document.getElementById("skeletonRelatorios");
    if(!form || !skel) return;

    form.addEventListener("submit", () => {
      skel.classList.remove("d-none");
      skel.scrollIntoView({behavior:"smooth", block:"start"});
    });
  })();
</script>

<script>
  // Habilita datas s√≥ no modo personalizado
  (function(){
    const periodo = document.querySelector('select[name="periodo"]');
    const inicio = document.querySelector('input[name="inicio"]');
    const fim = document.querySelector('input[name="fim"]');
    if(!periodo || !inicio || !fim) return;

    function toggleDates(){
      const custom = periodo.value === "custom";
      inicio.disabled = !custom;
      fim.disabled = !custom;
      inicio.classList.toggle("opacity-75", !custom);
      fim.classList.toggle("opacity-75", !custom);
    }

    periodo.addEventListener("change", toggleDates);
    toggleDates();
  })();
</script>

{% endblock %}